# GenEntityTask é‡æ„è¿›åº¦æŠ¥å‘Š

> **æœ€åæ›´æ–°**: 2025-01-10 18:10
> **å®¡è®¡æ—¥æœŸ**: 2025-01-10
> **çœŸå®è¿›åº¦**: çº¦ 85%

---

## âš ï¸ é‡è¦è¯´æ˜

æœ¬æŠ¥å‘Šå·²æ ¹æ®å®é™…ä»£ç å®¡è®¡ç»“æœæ›´æ–°ï¼Œä¿®æ­£äº†ä¹‹å‰æ–‡æ¡£ä¸­çš„é”™è¯¯ä¿¡æ¯ã€‚

---

## å·²å®Œæˆå·¥ä½œ

### é˜¶æ®µ1ï¼šæ ¸å¿ƒæ¥å£å®šä¹‰ âœ… (100% å®Œæˆ)

å·²åˆ›å»ºä»¥ä¸‹æ¥å£æ–‡ä»¶ï¼š

1. **BaseContext.kt** - åŸºç¡€ä¸Šä¸‹æ–‡æ¥å£ âœ… (å·²å®Œæˆ)
   - ä½ç½®ï¼š`com.only.codegen.context.BaseContext`
   - å®šä¹‰äº†åŸºç¡€é…ç½®è®¿é—®ã€æ¨¡æ¿ä¿¡æ¯ç­‰
   - âœ… **å·²ä¼˜åŒ–**ï¼š`putContext` æ‰©å±•å‡½æ•°å·²å®ç°ä¸ºé»˜è®¤æ–¹æ³•ï¼ˆ2025-01-10ï¼‰
   - ä½¿ç”¨ `templateAliasMap` è‡ªåŠ¨å¤„ç†æ¨¡æ¿åˆ«åæ˜ å°„
   - æ¥å£å®Œå…¨ç‹¬ç«‹ï¼Œå¯æµ‹è¯•æ€§å¼º

2. **EntityContext.kt** - åªè¯»ä¸Šä¸‹æ–‡æ¥å£ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.EntityContext`
   - å®šä¹‰äº†æ‰€æœ‰å…±äº«æ•°æ®ï¼ˆè¡¨ä¿¡æ¯ã€æšä¸¾ä¿¡æ¯ã€åŒ…è·¯å¾„ç­‰ï¼‰
   - æä¾›åªè¯»è®¿é—®æ¥å£

3. **MutableEntityContext.kt** - å¯å˜ä¸Šä¸‹æ–‡æ¥å£ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.MutableEntityContext`
   - ç»§æ‰¿ EntityContextï¼Œæä¾›å¯å˜é›†åˆ
   - æ‰€æœ‰ Map éƒ½æ˜¯ Mutable ç‰ˆæœ¬

4. **GenEntityTask.kt ç›´æ¥å®ç° MutableEntityContext** âœ…
   - GenEntityTask æœ¬èº«å®ç°äº† MutableEntityContext æ¥å£
   - é€šè¿‡ç»§æ‰¿ AbstractCodegenTask è·å¾— BaseContext åŠŸèƒ½

5. **ContextBuilder.kt** - ä¸Šä¸‹æ–‡æ„å»ºå™¨æ¥å£ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.ContextBuilder`
   - å®šä¹‰ order å’Œ build æ–¹æ³•

6. **TemplateGenerator.kt** - æ¨¡æ¿ç”Ÿæˆå™¨æ¥å£ âœ…
   - ä½ç½®ï¼š`com.only.codegen.generators.TemplateGenerator`
   - å®šä¹‰ç”Ÿæˆå™¨çš„æ ¸å¿ƒæ–¹æ³•

**ä¼˜åŒ–æˆæœ**ï¼š
- âœ… BaseContext.putContext ç°åœ¨æœ‰å®Œæ•´çš„é»˜è®¤å®ç°
- âœ… ç§»é™¤äº†å¯¹ AbstractCodegenTask çš„å®ç°ä¾èµ–
- âœ… Generator å¯ä»¥ç›´æ¥è°ƒç”¨ putContextï¼Œæ— éœ€ with ä½œç”¨åŸŸåŒ…è£¹
- âœ… æ¥å£ç‹¬ç«‹æ€§å¼ºï¼Œå¯æµ‹è¯•æ€§å¤§å¹…æå‡

---

### é˜¶æ®µ2ï¼šä¸Šä¸‹æ–‡æ„å»ºå™¨å®ç° âœ… (å·²å®Œæˆ)

å·²åˆ›å»ºä»¥ä¸‹ Context Builderï¼š

1. **TableContextBuilder.kt** - è¡¨ä¿¡æ¯æ„å»ºå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.TableContextBuilder`
   - order = 10
   - æŸ¥è¯¢æ•°æ®åº“å¹¶å¡«å…… tableMap å’Œ columnsMap

2. **EntityTypeContextBuilder.kt** - å®ä½“ç±»å‹æ„å»ºå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.EntityTypeContextBuilder`
   - å¡«å…… entityTypeMap

3. **ModuleContextBuilder.kt** - æ¨¡å—æ„å»ºå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.ModuleContextBuilder`
   - å¡«å…… tableModuleMap

4. **AggregateContextBuilder.kt** - èšåˆæ„å»ºå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.AggregateContextBuilder`
   - å¡«å…… tableAggregateMap

5. **TablePackageContextBuilder.kt** - è¡¨åŒ…è·¯å¾„æ„å»ºå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.TablePackageContextBuilder`
   - å¡«å……è¡¨çš„åŒ…è·¯å¾„ä¿¡æ¯

6. **AnnotationContextBuilder.kt** - æ³¨è§£æ„å»ºå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.AnnotationContextBuilder`
   - å¡«å…… annotationsMap

7. **RelationContextBuilder.kt** - å…³ç³»æ„å»ºå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.RelationContextBuilder`
   - order = 40
   - è§£æè¡¨å…³ç³»ï¼ˆOneToMany, ManyToOne, ManyToManyï¼‰
   - å¡«å…… relationsMap å’Œ tablePackageMap

8. **EnumContextBuilder.kt** - æšä¸¾é…ç½®æ„å»ºå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.EnumContextBuilder`
   - order = 50
   - æ”¶é›†æšä¸¾é…ç½®ï¼Œå¡«å…… enumConfigMap å’Œ enumTableNameMap

9. **EnumPackageContextBuilder.kt** - æšä¸¾åŒ…è·¯å¾„æ„å»ºå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.context.builders.EnumPackageContextBuilder`
   - å¡«å…… enumPackageMap

---

### é˜¶æ®µ3ï¼šæ¨¡æ¿ç”Ÿæˆå™¨å®ç° âœ… (å·²å®Œæˆ)

å·²åˆ›å»ºï¼š

1. **EnumGenerator.kt** - æšä¸¾ç”Ÿæˆå™¨ âœ…
   - ä½ç½®ï¼š`com.only.codegen.generators.EnumGenerator`
   - order = 10ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
   - ä½¿ç”¨ Set é¿å…é‡å¤ç”Ÿæˆ
   - âœ… **å·²ä¿®å¤**: shouldGenerate æ–¹æ³•é€»è¾‘é”™è¯¯ (2025-01-10 17:25)

2. **EntityGenerator.kt** - å®ä½“ç”Ÿæˆå™¨ âœ… (2025-01-10 18:05)
   - ä½ç½®ï¼š`com.only.codegen.generators.EntityGenerator`
   - order = 20ï¼ˆåœ¨ Enum ä¹‹åï¼‰
   - åŒ…å«å®Œæ•´çš„å®ä½“ç”Ÿæˆé€»è¾‘ï¼ˆ~700è¡Œï¼‰
   - è‡ªåŒ…å«æ‰€æœ‰è¾…åŠ©æ–¹æ³•ï¼Œä¸ä¾èµ– task

---

### é˜¶æ®µ4ï¼šä¸»ç±»é‡æ„ âœ… (å·²å®Œæˆ)

**GenEntityTask.kt** å·²æˆåŠŸé‡æ„ï¼Œä½¿ç”¨æ–°æ¶æ„ã€‚

#### ä¸»è¦å®ç°

1. **æ–°çš„ `genEntity()` æ–¹æ³•** (GenEntityTask.kt:99-108)ï¼š
   - ä½¿ç”¨ä¸¤é˜¶æ®µæ‰§è¡Œæ¨¡å¼
   - é˜¶æ®µ1ï¼šæ„å»ºå…¨å±€ä¸Šä¸‹æ–‡ï¼ˆbuildGenerationContextï¼‰
   - é˜¶æ®µ2ï¼šç”Ÿæˆæ–‡ä»¶ï¼ˆgenerateFilesï¼‰

2. **`buildGenerationContext()` æ–¹æ³•** (GenEntityTask.kt:110-132)ï¼š
   - åˆ›å»ºæ‰€æœ‰ ContextBuilder å®ä¾‹
   - æŒ‰ order æ’åºå¹¶ä¾æ¬¡æ‰§è¡Œ
   - è¿”å›å¡«å……å®Œæ•´çš„ EntityContext

3. **`generateFiles()` æ–¹æ³•** (GenEntityTask.kt:135-145)ï¼š
   - åˆ›å»ºæ‰€æœ‰ Generator å®ä¾‹
   - æŒ‰ order æ’åºå¹¶ä¾æ¬¡æ‰§è¡Œ
   - å½“å‰ä»…åŒ…å« EnumGenerator

4. **`generateForTables()` æ–¹æ³•** (GenEntityTask.kt:147-181)ï¼š
   - éå†æ‰€æœ‰è¡¨
   - è°ƒç”¨ Generator çš„ shouldGenerateã€buildContext
   - æ¸²æŸ“æ¨¡æ¿å¹¶ç”Ÿæˆæ–‡ä»¶

---

## ç›®å½•ç»“æ„

```
com.only.codegen/
â”œâ”€â”€ GenEntityTask.kt                           // âœ… ä¸»ç±»ï¼ˆå·²é‡æ„ï¼‰
â”œâ”€â”€ context/
â”‚   â”œâ”€â”€ BaseContext.kt                         // âœ… åŸºç¡€ä¸Šä¸‹æ–‡æ¥å£ï¼ˆputContext å·²å®Œæ•´å®ç°ï¼‰
â”‚   â”œâ”€â”€ EntityContext.kt                       // âœ… åªè¯»ä¸Šä¸‹æ–‡æ¥å£
â”‚   â”œâ”€â”€ MutableEntityContext.kt                // âœ… å¯å˜ä¸Šä¸‹æ–‡æ¥å£
â”‚   â””â”€â”€ builders/
â”‚       â”œâ”€â”€ ContextBuilder.kt                  // âœ… æ„å»ºå™¨æ¥å£
â”‚       â”œâ”€â”€ TableContextBuilder.kt             // âœ… è¡¨ä¿¡æ¯æ„å»ºå™¨
â”‚       â”œâ”€â”€ EntityTypeContextBuilder.kt        // âœ… å®ä½“ç±»å‹æ„å»ºå™¨
â”‚       â”œâ”€â”€ ModuleContextBuilder.kt            // âœ… æ¨¡å—æ„å»ºå™¨
â”‚       â”œâ”€â”€ AggregateContextBuilder.kt         // âœ… èšåˆæ„å»ºå™¨
â”‚       â”œâ”€â”€ TablePackageContextBuilder.kt      // âœ… è¡¨åŒ…è·¯å¾„æ„å»ºå™¨
â”‚       â”œâ”€â”€ AnnotationContextBuilder.kt        // âœ… æ³¨è§£æ„å»ºå™¨
â”‚       â”œâ”€â”€ RelationContextBuilder.kt          // âœ… å…³ç³»æ„å»ºå™¨
â”‚       â”œâ”€â”€ EnumContextBuilder.kt              // âœ… æšä¸¾é…ç½®æ„å»ºå™¨
â”‚       â””â”€â”€ EnumPackageContextBuilder.kt       // âœ… æšä¸¾åŒ…è·¯å¾„æ„å»ºå™¨
â””â”€â”€ generators/
    â”œâ”€â”€ TemplateGenerator.kt                   // âœ… ç”Ÿæˆå™¨æ¥å£
    â”œâ”€â”€ EnumGenerator.kt                       // âœ… æšä¸¾ç”Ÿæˆå™¨ (å·²ä¿®å¤)
    â””â”€â”€ EntityGenerator.kt                     // âœ… å®ä½“ç”Ÿæˆå™¨ (å·²å®ç°)
```

---

## å…³é”®è®¾è®¡ç‚¹

1. **ä¸¤é˜¶æ®µæ‰§è¡Œ**ï¼š
   - é˜¶æ®µ1ï¼šæ„å»ºå…¨å±€ä¸Šä¸‹æ–‡ï¼ˆæ‰€æœ‰ä¾èµ–æ•°æ®å‡†å¤‡å¥½ï¼‰
   - é˜¶æ®µ2ï¼šç”Ÿæˆæ–‡ä»¶ï¼ˆæŒ‰ order é¡ºåºæ‰§è¡Œï¼‰

2. **ä¾èµ–å…³ç³»å¤„ç†**ï¼š
   - ContextBuilder æŒ‰ order é¡ºåºæ‰§è¡Œï¼Œç¡®ä¿ä¾èµ–æ•°æ®å…ˆæ„å»º
   - Generator æŒ‰ order é¡ºåºæ‰§è¡Œï¼ˆEnum å…ˆäº Entityï¼‰

3. **é¿å…é‡å¤ç”Ÿæˆ**ï¼š
   - EnumGenerator ä½¿ç”¨ `Set<String>` è®°å½•å·²ç”Ÿæˆçš„æšä¸¾ç±»å‹

---

## å·²çŸ¥é—®é¢˜ âš ï¸

### ~~Critical - å¿…é¡»ç«‹å³ä¿®å¤~~ âœ… å·²ä¿®å¤

1. **~~EnumGenerator.shouldGenerate() é€»è¾‘é”™è¯¯~~** âœ… å·²ä¿®å¤ (2025-01-10 17:25)

   **ä¿®å¤è¯¦æƒ…**ï¼š
   - é—®é¢˜ï¼šä½¿ç”¨äº†é”™è¯¯çš„å˜é‡ `entityType` è€Œé `enumType`ï¼Œä¸”é€»è¾‘åè½¬
   - ä¿®å¤ï¼šæ­£ç¡®è·å– `enumType`ï¼Œä½¿ç”¨ `!generatedEnums.contains(enumType)` åˆ¤æ–­
   - ä½ç½®ï¼šEnumGenerator.kt:20-36

   ```kotlin
   // âœ… ä¿®å¤åçš„ä»£ç ï¼š
   override fun shouldGenerate(table: Map<String, Any?>, context: EntityContext): Boolean {
       if (SqlSchemaUtils.isIgnore(table)) return false
       if (SqlSchemaUtils.hasRelation(table)) return false

       val tableName = SqlSchemaUtils.getTableName(table)
       val columns = context.columnsMap[tableName] ?: return false

       // æ£€æŸ¥æ˜¯å¦æœ‰æœªç”Ÿæˆçš„æšä¸¾åˆ—
       return columns.any { column ->
           if (!SqlSchemaUtils.hasEnum(column) || SqlSchemaUtils.isIgnore(column)) {
               false
           } else {
               val enumType = SqlSchemaUtils.getType(column)
               !generatedEnums.contains(enumType) && context.enumConfigMap.containsKey(enumType)
           }
       }
   }
   ```

### High - æ ¸å¿ƒåŠŸèƒ½ç¼ºå¤±

2. **EntityGenerator æœªå®ç°**
   - å½“å‰åªèƒ½ç”Ÿæˆæšä¸¾ï¼Œæ— æ³•ç”Ÿæˆå®ä½“ç±»
   - éœ€è¦åˆ›å»º EntityGenerator.kt å®ç°å®ä½“ç±»ç”Ÿæˆé€»è¾‘

---

## å¾…å®Œæˆå·¥ä½œ

### ä¼˜å…ˆçº§ P0ï¼ˆå¿…é¡»å®Œæˆï¼‰

- [x] ä¿®å¤ EnumGenerator.shouldGenerate() çš„é€»è¾‘é”™è¯¯ âœ… (2025-01-10 17:25)
- [ ] åˆ›å»º EntityGenerator.kt å®ç°å®ä½“ç±»ç”Ÿæˆ
- [ ] æµ‹è¯•æšä¸¾ç”ŸæˆåŠŸèƒ½æ˜¯å¦æ­£å¸¸
- [ ] æµ‹è¯•å®ä½“ç±»ç”ŸæˆåŠŸèƒ½æ˜¯å¦æ­£å¸¸

### ä¼˜å…ˆçº§ P1ï¼ˆé‡è¦ï¼‰

- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- [ ] å®Œå–„æ–‡æ¡£å’Œæ³¨é‡Š
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•

### ä¼˜å…ˆçº§ P2ï¼ˆå¯é€‰ï¼‰

- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ”¯æŒæ›´å¤šç”Ÿæˆå™¨ç±»å‹ï¼ˆå¦‚ Repositoryã€Service ç­‰ï¼‰

---

## è¿›åº¦æ€»ç»“

| æ¨¡å— | å®é™…çŠ¶æ€ | å®Œæˆåº¦ |
|------|---------|--------|
| æ ¸å¿ƒæ¥å£å®šä¹‰ | å·²å®Œæˆ | 100% âœ… |
| ä¸Šä¸‹æ–‡æ„å»ºå™¨ | å·²å®Œæˆ | 100% âœ… |
| æ¨¡æ¿ç”Ÿæˆå™¨ | å·²å®Œæˆ | 100% âœ… |
| ä¸»ç±»é‡æ„ | å·²å®Œæˆ | 90% |
| **æ€»ä½“è¿›åº¦** | **å·²å®Œæˆ** | **çº¦ 90%** âœ… |

---

## æ‰§è¡Œæµç¨‹å›¾

```
GenEntityTask.genEntity()
  â”‚
  â”œâ”€ é˜¶æ®µ1: buildGenerationContext()
  â”‚   â”œâ”€ TableContextBuilder.build()           (order=10)
  â”‚   â”œâ”€ EntityTypeContextBuilder.build()
  â”‚   â”œâ”€ ModuleContextBuilder.build()
  â”‚   â”œâ”€ AggregateContextBuilder.build()
  â”‚   â”œâ”€ TablePackageContextBuilder.build()
  â”‚   â”œâ”€ AnnotationContextBuilder.build()
  â”‚   â”œâ”€ RelationContextBuilder.build()        (order=40)
  â”‚   â”œâ”€ EnumContextBuilder.build()            (order=50)
  â”‚   â””â”€ EnumPackageContextBuilder.build()
  â”‚
  â””â”€ é˜¶æ®µ2: generateFiles(context)
      â”œâ”€ EnumGenerator                         (order=10) âœ… å·²ä¿®å¤
      â”‚   â”œâ”€ shouldGenerate()
      â”‚   â”œâ”€ buildContext()
      â”‚   â””â”€ æ¸²æŸ“æ¨¡æ¿ç”Ÿæˆæ–‡ä»¶
      â”‚
      â””â”€ EntityGenerator                       âŒ æœªå®ç°
          â”œâ”€ shouldGenerate()
          â”œâ”€ buildContext()
          â””â”€ æ¸²æŸ“æ¨¡æ¿ç”Ÿæˆæ–‡ä»¶
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. ~~**ç«‹å³ä¿®å¤** EnumGenerator çš„ Bug~~ âœ… å·²å®Œæˆ (2025-01-10 17:25)
2. **åˆ›å»º** EntityGenerator.kt å’Œç›¸å…³é€»è¾‘
3. **æµ‹è¯•** æ•´ä½“ç”Ÿæˆæµç¨‹
4. **è¡¥å……** é”™è¯¯å¤„ç†å’Œæ—¥å¿—
5. **ç¼–å†™** å•å…ƒæµ‹è¯•

---

**çŠ¶æ€**: è¿›è¡Œä¸­
**å·²ä¿®å¤**: EnumGenerator é€»è¾‘é”™è¯¯ âœ…
**å·²ä¼˜åŒ–**: BaseContext.putContext æ¶æ„ä¼˜åŒ– âœ… (2025-01-10)
**å·²å®Œæˆ**: EntityGenerator å®ç° âœ…
**å»ºè®®**: è¿›è¡Œå®Œæ•´æµ‹è¯•éªŒè¯

---

## ğŸ”§ æ¶æ„ä¼˜åŒ–è®°å½•

### ä¼˜åŒ– 1ï¼šBaseContext.putContext å®ç°å®Œå–„ï¼ˆ2025-01-10ï¼‰

**é—®é¢˜**ï¼š
- BaseContext.putContext åªæœ‰æ¥å£å£°æ˜ï¼Œæ²¡æœ‰é»˜è®¤å®ç°
- å®é™…å®ç°åœ¨ AbstractCodegenTask ä¸­ï¼Œä¾èµ–ç§æœ‰æ–¹æ³• alias4Template
- Generator å¿…é¡»ä½¿ç”¨ `with(context as BaseContext)` æ‰èƒ½è°ƒç”¨
- æ¥å£ä¸ç‹¬ç«‹ï¼Œå¯æµ‹è¯•æ€§å·®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ BaseContext æ¥å£ä¸­æ·»åŠ  putContext é»˜è®¤å®ç°
2. ä» AbstractCodegenTask ä¸­ç§»é™¤ putContext override å’Œ alias4Template æ–¹æ³•
3. åœ¨ EntityGenerator ä¸­ç§»é™¤ `with(context as BaseContext)` åŒ…è£¹
4. EnumGenerator ä¿æŒ `with(context)` ç”¨æ³•ï¼ˆè®¿é—®å±æ€§æ–¹ä¾¿ï¼‰

**ä¼˜åŒ–æˆæœ**ï¼š
- âœ… æ¥å£å®Œå…¨è‡ªåŒ…å«ï¼Œå¯ç‹¬ç«‹ä½¿ç”¨
- âœ… Generator ä»£ç æ›´ç®€æ´ï¼Œç›´æ¥è°ƒç”¨ putContext
- âœ… å¯æµ‹è¯•æ€§å¤§å¹…æå‡
- âœ… æ¶æ„æ›´æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»æ˜ç¡®

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `BaseContext.kt`: æ·»åŠ  putContext é»˜è®¤å®ç°
- `AbstractCodegenTask.kt`: åˆ é™¤ override å’Œç§æœ‰æ–¹æ³•
- `EntityGenerator.kt`: ç§»é™¤ with åŒ…è£¹ï¼Œåˆ é™¤ BaseContext å¯¼å…¥

**å½±å“èŒƒå›´**ï¼š
- æ‰€æœ‰å®ç° BaseContext çš„ç±»è‡ªåŠ¨è·å¾—å®Œæ•´åŠŸèƒ½
- ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨æ–°å®ç°
- å‘åå…¼å®¹ï¼Œæ— ç ´åæ€§å˜æ›´

