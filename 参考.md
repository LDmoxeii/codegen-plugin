åŸºäº KSP + KotlinPoet + Pebble çš„ä»£ç ç”Ÿæˆå™¨æ¶æ„è®¾è®¡
åŸºäºæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å°†è®¾è®¡ä¸€ä¸ªæ”¯æŒæ•°æ®åº“ä¼˜å…ˆå’Œå…ƒä¿¡æ¯ä¼˜å…ˆä¸¤ç§ä»£ç ç”Ÿæˆæ–¹å¼çš„ä»£ç ç”Ÿæˆå™¨ã€‚ä»¥ä¸‹æ˜¯æŠ½è±¡å‡ºçš„æ ¸å¿ƒæ¥å£ï¼š

ğŸ—ï¸ æ ¸å¿ƒæ¶æ„æ¦‚è§ˆ
text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä»£ç ç”Ÿæˆå™¨æ ¸å¿ƒå¼•æ“                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å…ƒæ•°æ®æå–å™¨  â”‚  â”‚  ä»£ç ç”Ÿæˆç­–ç•¥  â”‚  â”‚     è¾“å‡ºç®¡ç†å™¨       â”‚  â”‚
â”‚  â”‚ IMetadata   â”‚  â”‚ IGeneration â”‚  â”‚    IOutputManager   â”‚  â”‚
â”‚  â”‚ Extractor   â”‚  â”‚  Strategy   â”‚  â”‚                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                    â”‚                    â”‚
â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®åº“å…ƒæ•°æ®æå–å™¨  â”‚ â”‚ Pebbleæ¨¡æ¿ç”Ÿæˆå™¨  â”‚ â”‚   æ–‡ä»¶ç³»ç»Ÿè¾“å‡ºå™¨    â”‚
â”‚ DatabaseMetadata â”‚ â”‚ PebbleGeneration â”‚ â”‚ FileOutputManager â”‚
â”‚   Extractor     â”‚ â”‚     Strategy     â”‚ â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ³¨è§£å…ƒæ•°æ®æå–å™¨   â”‚ â”‚ KotlinPoetç”Ÿæˆå™¨  â”‚ â”‚   å†…å­˜è¾“å‡ºå™¨       â”‚
â”‚ Annotation      â”‚ â”‚ KotlinPoet       â”‚ â”‚ MemoryOutput      â”‚
â”‚ MetadataExtractorâ”‚ â”‚ GenerationStrategyâ”‚ â”‚ Manager          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ğŸ“‹ æ ¸å¿ƒæ¥å£è®¾è®¡
1. å…ƒæ•°æ®æå–å™¨æ¥å£ (Metadata Extraction)
   kotlin
   /**
* å…ƒæ•°æ®æå–å™¨æ¥å£ - è´Ÿè´£ä»ä¸åŒæ¥æºæå–å…ƒæ•°æ®
  */
  interface IMetadataExtractor {

  /**
    * æå–å®ä½“å…ƒæ•°æ®
      */
      fun extractEntityMetadata(): List<EntityMetadata>

  /**
    * æå–æšä¸¾å…ƒæ•°æ®
      */
      fun extractEnumMetadata(): List<EnumMetadata>

  /**
    * æå–å…³ç³»å…ƒæ•°æ®
      */
      fun extractRelationshipMetadata(): List<RelationshipMetadata>

  /**
    * éªŒè¯å…ƒæ•°æ®å®Œæ•´æ€§
      */
      fun validateMetadata(): ValidationResult
      }

/**
* æ•°æ®åº“å…ƒæ•°æ®æå–å™¨
  */
  interface IDatabaseMetadataExtractor : IMetadataExtractor {

  /**
    * è·å–æ•°æ®åº“è¿æ¥
      */
      fun getConnection(): Connection

  /**
    * æå–è¡¨ç»“æ„ä¿¡æ¯
      */
      fun extractTableMetadata(): List<TableMetadata>

  /**
    * æå–ç´¢å¼•ä¿¡æ¯
      */
      fun extractIndexMetadata(): List<IndexMetadata>
      }

/**
* æ³¨è§£å…ƒæ•°æ®æå–å™¨
  */
  interface IAnnotationMetadataExtractor : IMetadataExtractor {

  /**
    * å¤„ç†KSPç¬¦å·
      */
      fun processSymbols(symbols: Sequence<KSAnnotated>)

  /**
    * æå–è‡ªå®šä¹‰æ³¨è§£ä¿¡æ¯
      */
      fun extractCustomAnnotations(): List<AnnotationMetadata>
      }
2. æ•°æ®æ¨¡å‹æ¥å£ (Data Models)
   kotlin
   /**
* å®ä½“å…ƒæ•°æ®
  */
  data class EntityMetadata(
  val name: String,
  val tableName: String,
  val packageName: String,
  val fields: List<FieldMetadata>,
  val primaryKey: PrimaryKeyMetadata?,
  val indices: List<IndexMetadata>,
  val annotations: List<AnnotationMetadata>,
  val description: String? = null
  )

/**
* å­—æ®µå…ƒæ•°æ®
  */
  data class FieldMetadata(
  val name: String,
  val columnName: String,
  val type: FieldType,
  val isNullable: Boolean,
  val isPrimaryKey: Boolean,
  val isAutoIncrement: Boolean,
  val defaultValue: Any?,
  val length: Int?,
  val precision: Int?,
  val scale: Int?,
  val annotations: List<AnnotationMetadata>,
  val validationRules: List<ValidationRule>
  )

/**
* å­—æ®µç±»å‹æšä¸¾
  */
  sealed class FieldType {
  data class PrimitiveType(val typeName: String) : FieldType()
  data class EntityType(val entityName: String) : FieldType()
  data class EnumType(val enumName: String) : FieldType()
  data class CollectionType(val elementType: FieldType) : FieldType()
  }
3. ä»£ç ç”Ÿæˆç­–ç•¥æ¥å£ (Generation Strategy)
   kotlin
   /**
* ä»£ç ç”Ÿæˆç­–ç•¥æ¥å£
  */
  interface IGenerationStrategy {

  /**
    * ç”Ÿæˆå®ä½“ç±»ä»£ç 
      */
      fun generateEntity(entity: EntityMetadata): GenerationResult

  /**
    * ç”ŸæˆRepositoryä»£ç 
      */
      fun generateRepository(entity: EntityMetadata): GenerationResult

  /**
    * ç”ŸæˆServiceä»£ç 
      */
      fun generateService(entity: EntityMetadata): GenerationResult

  /**
    * ç”ŸæˆDTOä»£ç 
      */
      fun generateDTO(entity: EntityMetadata): GenerationResult

  /**
    * ç”Ÿæˆæšä¸¾ç±»ä»£ç 
      */
      fun generateEnum(enumMetadata: EnumMetadata): GenerationResult
      }

/**
* Pebbleæ¨¡æ¿ç”Ÿæˆç­–ç•¥
  */
  interface IPebbleGenerationStrategy : IGenerationStrategy {

  /**
    * è®¾ç½®æ¨¡æ¿å¼•æ“
      */
      fun setTemplateEngine(engine: PebbleEngine)

  /**
    * åŠ è½½æ¨¡æ¿
      */
      fun loadTemplate(templateName: String, context: Map<String, Any>): String

  /**
    * æ³¨å†Œè‡ªå®šä¹‰è¿‡æ»¤å™¨
      */
      fun registerFilter(filterName: String, filter: PebbleFilter)
      }

/**
* KotlinPoetç”Ÿæˆç­–ç•¥
  */
  interface IKotlinPoetGenerationStrategy : IGenerationStrategy {

  /**
    * ç”ŸæˆTypeSpec
      */
      fun generateTypeSpec(entity: EntityMetadata): TypeSpec

  /**
    * ç”ŸæˆFileSpec
      */
      fun generateFileSpec(entity: EntityMetadata): FileSpec

  /**
    * æ·»åŠ è‡ªå®šä¹‰ä»£ç å—ç”Ÿæˆå™¨
      */
      fun addCustomBlockGenerator(generator: ICodeBlockGenerator)
      }
4. æ¨¡æ¿ç®¡ç†æ¥å£ (Template Management)
   kotlin
   /**
* æ¨¡æ¿ç®¡ç†å™¨æ¥å£
  */
  interface ITemplateManager {

  /**
    * è·å–æ¨¡æ¿å†…å®¹
      */
      fun getTemplate(templateName: String): String

  /**
    * æ³¨å†Œæ¨¡æ¿
      */
      fun registerTemplate(templateName: String, templateContent: String)

  /**
    * éªŒè¯æ¨¡æ¿è¯­æ³•
      */
      fun validateTemplate(templateName: String): ValidationResult

  /**
    * è·å–å¯ç”¨æ¨¡æ¿åˆ—è¡¨
      */
      fun getAvailableTemplates(): List<TemplateInfo>
      }

/**
* ä»£ç å—ç”Ÿæˆå™¨æ¥å£ - ç”¨äºKotlinPoetç”Ÿæˆä»£ç å—
  */
  interface ICodeBlockGenerator {

  /**
    * ç”Ÿæˆå­—æ®µå£°æ˜ä»£ç å—
      */
      fun generateFieldDeclaration(field: FieldMetadata): CodeBlock

  /**
    * ç”ŸæˆGetteræ–¹æ³•ä»£ç å—
      */
      fun generateGetterMethod(field: FieldMetadata): FunSpec

  /**
    * ç”ŸæˆSetteræ–¹æ³•ä»£ç å—
      */
      fun generateSetterMethod(field: FieldMetadata): FunSpec

  /**
    * ç”ŸæˆBuilderæ¨¡å¼ä»£ç å—
      */
      fun generateBuilderPattern(entity: EntityMetadata): TypeSpec
      }
5. è¾“å‡ºç®¡ç†æ¥å£ (Output Management)
   kotlin
   /**
* è¾“å‡ºç®¡ç†å™¨æ¥å£
  */
  interface IOutputManager {

  /**
    * å†™å…¥ç”Ÿæˆçš„ä»£ç 
      */
      fun writeOutput(generationResult: GenerationResult)

  /**
    * åˆ›å»ºç›®å½•ç»“æ„
      */
      fun createDirectoryStructure(packageName: String)

  /**
    * æ¸…ç†è¾“å‡ºç›®å½•
      */
      fun cleanOutput()

  /**
    * è·å–ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨
      */
      fun getGeneratedFiles(): List<FileInfo>
      }

/**
* ç”Ÿæˆç»“æœ
  */
  data class GenerationResult(
  val fileName: String,
  val content: String,
  val packageName: String,
  val type: OutputType,
  val metadata: Map<String, Any> = emptyMap()
  )

/**
* è¾“å‡ºç±»å‹æšä¸¾
  */
  enum class OutputType {
  ENTITY, REPOSITORY, SERVICE, DTO, ENUM, CONFIGURATION
  }
6. é…ç½®ç®¡ç†æ¥å£ (Configuration Management)
   kotlin
   /**
* é…ç½®ç®¡ç†å™¨æ¥å£
  */
  interface IConfigurationManager {

  /**
    * è·å–ç”Ÿæˆé…ç½®
      */
      fun getGenerationConfig(): GenerationConfig

  /**
    * è·å–æ•°æ®åº“é…ç½®
      */
      fun getDatabaseConfig(): DatabaseConfig

  /**
    * è·å–æ¨¡æ¿é…ç½®
      */
      fun getTemplateConfig(): TemplateConfig

  /**
    * é‡æ–°åŠ è½½é…ç½®
      */
      fun reloadConfig()
      }

/**
* ç”Ÿæˆé…ç½®
  */
  data class GenerationConfig(
  val strategy: GenerationStrategyType,
  val outputPath: String,
  val basePackage: String,
  val generateRepositories: Boolean,
  val generateServices: Boolean,
  val generateDTOs: Boolean,
  val useLombok: Boolean,
  val useBuilderPattern: Boolean,
  val validationFramework: ValidationFramework
  )

/**
* ç”Ÿæˆç­–ç•¥ç±»å‹æšä¸¾
  */
  enum class GenerationStrategyType {
  DATABASE_FIRST, METADATA_FIRST, HYBRID
  }
7. éªŒè¯æ¥å£ (Validation)
   kotlin
   /**
* éªŒè¯å™¨æ¥å£
  */
  interface IMetadataValidator {

  /**
    * éªŒè¯å®ä½“å…ƒæ•°æ®
      */
      fun validateEntity(entity: EntityMetadata): ValidationResult

  /**
    * éªŒè¯å­—æ®µå…ƒæ•°æ®
      */
      fun validateField(field: FieldMetadata): ValidationResult

  /**
    * éªŒè¯å…³ç³»å…ƒæ•°æ®
      */
      fun validateRelationship(relationship: RelationshipMetadata): ValidationResult
      }

/**
* éªŒè¯ç»“æœ
  */
  data class ValidationResult(
  val isValid: Boolean,
  val errors: List<ValidationError>,
  val warnings: List<ValidationWarning>
  )

/**
* éªŒè¯è§„åˆ™æ¥å£
  */
  interface IValidationRule {

  /**
    * éªŒè¯å­—æ®µå€¼
      */
      fun validate(field: FieldMetadata, value: Any?): ValidationResult

  /**
    * ç”ŸæˆéªŒè¯ä»£ç 
      */
      fun generateValidationCode(field: FieldMetadata): CodeBlock
      }
8. ä¸»æ§åˆ¶å™¨æ¥å£ (Main Controller)
   kotlin
   /**
* ä»£ç ç”Ÿæˆå™¨ä¸»æ§åˆ¶å™¨
  */
  interface ICodeGenerator {

  /**
    * åˆå§‹åŒ–ç”Ÿæˆå™¨
      */
      fun initialize(config: GenerationConfig)

  /**
    * æ‰§è¡Œä»£ç ç”Ÿæˆ
      */
      fun generate(): GenerationReport

  /**
    * æ³¨å†Œè‡ªå®šä¹‰ç”Ÿæˆå™¨
      */
      fun registerCustomGenerator(generator: ICustomGenerator)

  /**
    * æ·»åŠ ç”Ÿæˆåå¤„ç†å™¨
      */
      fun addPostProcessor(processor: IPostProcessor)
      }

/**
* è‡ªå®šä¹‰ç”Ÿæˆå™¨æ¥å£
  */
  interface ICustomGenerator {

  /**
    * ç”Ÿæˆè‡ªå®šä¹‰ä»£ç 
      */
      fun generateCustomCode(metadata: Any): GenerationResult

  /**
    * æ”¯æŒçš„å…ƒæ•°æ®ç±»å‹
      */
      fun supportedMetadataTypes(): List<Class<*>>
      }

/**
* ç”Ÿæˆåå¤„ç†å™¨æ¥å£
  */
  interface IPostProcessor {

  /**
    * å¤„ç†ç”Ÿæˆçš„ä»£ç 
      */
      fun process(generatedFiles: List<FileInfo>): PostProcessResult

  /**
    * æ ¼å¼åŒ–ä»£ç 
      */
      fun formatCode(content: String): String

  /**
    * æ·»åŠ æ–‡ä»¶å¤´æ³¨é‡Š
      */
      fun addFileHeader(fileContent: String, entity: EntityMetadata): String
      }
